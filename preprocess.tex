%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Preprocess: shared preamble and setup
% This file is intended to be reused by multiple books
% (e.g. My Chess Notebook, Endgame, etc.).
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[
	11pt, % Default font size, select one of 10pt, 11pt or 12pt
	fleqn, % Left align equations
	a4paper, % Paper size, use either 'a4paper' for A4 size or 'letterpaper' for US letter size
	oneside, % Oneside mode, more suitable if the book is to be read on a screen or print-on-demand
]{memoir}

%----------------------------------------------------------------------------------------
%	CORE PACKAGES (replacing what the old class loaded)
%----------------------------------------------------------------------------------------

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}

\usepackage{graphicx}
\usepackage[usenames, svgnames, table]{xcolor}

\usepackage{lmodern} % Latin Modern = scalable Computer Modern
\usepackage{microtype}

\usepackage{geometry}
\geometry{
	top=3cm,
	bottom=2.5cm,
	inner=1.5cm,
	outer=1.5cm,
	headsep=10pt,
	headheight=14pt,
	footskip=1.4cm,
	columnsep=1cm
}

\usepackage{hyperref}
\usepackage[nonumberlist]{glossaries}
\makeglossaries

% Header/footer styling similar to the old Legrand template
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0.5pt}
% Clear all headers and footers first, then set up the fancy style
\fancyhf{}
% Set up fancy pagestyle: chapter name in header, page numbers in footers
% Note: Since document is oneside, we show only chapter name to avoid overlap
% If section name exists, show "Chapter: Section", otherwise just "Chapter"
\fancyhead[L]{\leftmark}      % Left: chapter name (primary)
\fancyhead[R]{}                % Right: empty (to prevent overlap)
\fancyfoot[C]{\thepage}       % Center: page numbers in footer (consistent with plain style)

% Redefine plain pagestyle for chapter opening pages
% Chapter opening pages traditionally have clean headers (no chapter/section names)
% but should still show page numbers in the footer
% Note: In memoir, \chapter* uses the plain pagestyle, so we must ensure it has page numbers
\fancypagestyle{plain}{%
  % Clear all headers and footers first
  \fancyhf{}%
  % Set headers to empty (clean look for chapter opening pages)
  \fancyhead[L]{}\fancyhead[R]{}\fancyhead[C]{}%
  \fancyhead[LE]{}\fancyhead[RO]{}\fancyhead[LO]{}\fancyhead[RE]{}%
  % Clear left and right footers, set center footer with page number
  \fancyfoot[L]{}\fancyfoot[R]{}%
  \fancyfoot[C]{\thepage}%        % Page number in center footer (standard for chapter pages)
  % Remove rule lines for clean appearance
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
}

% Section and TOC formatting (you were already using these)
\usepackage[explicit]{titlesec}
\usepackage{tocloft}

% Bibliography and index setup (mirroring the old class)
\usepackage[
	backend=biber,
	bibstyle=numeric,
	citestyle=numeric,
	sorting=nyt,
	sortcites=true,
	abbreviate=false,
	backref=true
]{biblatex}
\defbibheading{bibempty}{}

\usepackage{makeidx}
\makeindex
\usepackage{etoolbox}

%----------------------------------------------------------------------------------------
%	BOOK METADATA & BUILD FLAGS
%----------------------------------------------------------------------------------------

% Allow each book to override title/author by defining these commands
% *before* loading this file. If not provided, fall back to defaults.
\providecommand{\BookTitle}{My Chess Notebook}
\providecommand{\BookAuthor}{Ming Lu}

% Control whether to build all heavy chapters (ideas, games, annotations).
% Default: build everything. A wrapper file can define \nobuildall before
% loading this file to disable them.
\newif\ifbuildall
\buildalltrue
\ifdefined\nobuildall
  \buildallfalse
\fi

% PDF metadata and link appearance
\hypersetup{
	pdftitle={\BookTitle}, % Title field
	pdfauthor={\BookAuthor}, % Author field
	pdfsubject={Chess}, % Subject field
	pdfkeywords={chess, ideas, games, annotations}, % Keywords
	pdfcreator={LaTeX}, % Content creator field
	% Make links colored instead of framed rectangles
	colorlinks=true,
	linkcolor=ocre,
	citecolor=ocre,
	urlcolor=ocre
}

\addbibresource{../sample.bib} % Bibliography file (relative to book folder)

\definecolor{ocre}{RGB}{243, 102, 25} % Define the color used for highlighting throughout the book

% These commands came from the old Legrand class; provide no-op versions so
% existing content still compiles under memoir. You can later redefine them
% if you want fancy chapter images again.
\newcommand{\chapterimage}[1]{} % Chapter heading image (ignored for now)
\newcommand{\chapterspaceabove}[1]{} % Whitespace above chapter title box
\newcommand{\chapterspacebelow}[1]{} % Whitespace below chapter title box

\chapterimage{../Images/zen-stone.jpg}
\chapterspaceabove{6.5cm}
\chapterspacebelow{6.75cm}

\usepackage{chessboard}
\usepackage{xskak}
\usepackage{sectsty}
\usepackage{tocloft}
\usepackage{epigraph}
\usepackage{multicol}
\usepackage{tikz}

% Define \titlepage command to match Legrand template style
% Usage: \titlepage{background image code}{title text}{author text}
\newcommand{\titlepage}[3]{%
	\thispagestyle{empty}%
	\newgeometry{left=0cm,right=0cm,top=0cm,bottom=0cm}%
	\begin{tikzpicture}[remember picture,overlay]%
		\node[anchor=center,inner sep=0] at (current page.center) {#1};%
		\node[anchor=center,align=center] at ([yshift=3cm]current page.center) {\rmfamily\fontsize{50}{60}\selectfont\bfseries #2};%
		\node[anchor=center,align=center] at ([yshift=-2cm]current page.center) {\rmfamily\fontsize{36}{44}\selectfont\bfseries #3};%
	\end{tikzpicture}%
	\restoregeometry%
	\clearpage%
}

\begin{document}

%----------------------------------------------------------------------------------------
%	TITLE PAGE (memoir style)
%----------------------------------------------------------------------------------------

\titlepage % Output the title page
	{\includegraphics[width=\paperwidth,height=\paperheight,keepaspectratio=false]{../Images/Delicate chessboard with a soft accent.png}} % Code to output the background image, which should be the same dimensions as the paper to fill the page entirely; leave empty for no background image
	{\BookTitle} % Book title
	{\BookAuthor} % Author name

%----------------------------------------------------------------------------------------
%	COPYRIGHT PAGE
%----------------------------------------------------------------------------------------

\thispagestyle{empty} % Suppress headers and footers on this page

~\vfill % Push the text down to the bottom of the page

\noindent Copyright \copyright\ 2025 Ming Lu\\ % Copyright notice

%----------------------------------------------------------------------------------------
%	DEDICATION PAGE
%----------------------------------------------------------------------------------------

\thispagestyle{empty} % Suppress headers and footers on this page

~\vfill % Push the text down to the center of the page

\begin{center}
\fontsize{24}{30}\selectfont\emph{To my parents}
\end{center}

~\vfill % Push the text to the center

%----------------------------------------------------------------------------------------
%	TABLE OF CONTENTS
%----------------------------------------------------------------------------------------
\newpage
\setcounter{page}{1} % Reset page counter so TOC starts at page 1
\pagestyle{empty} % Disable headers and footers for the following pages
\newcommand{\Color}[1]{\hypersetup{linkcolor=#1}\color{#1}}

\titlespacing*{\part}{10em}{0em}{0em}
% Optionally change font style
\renewcommand{\cftpartfont}{\Large\bfseries\Color{ocre}} 
\renewcommand{\cftchapfont}{\Large\bfseries\Color{ocre}} 
\renewcommand{\cftsecfont}{\large}  % Bold section font
\renewcommand{\cftsubsecfont}{\large\itshape} % Italic subsection font
\renewcommand{\cftsecpagefont}{\large}   % Page numbers for sections
\renewcommand{\cftsubsecpagefont}{\large} % Page numbers for subsections

% Set TOC depth to include subsections (level 3)
\setcounter{tocdepth}{3}

\begingroup % start a TeX group
\color{ocre}% or whatever color you wish to use
\tableofcontents* % Output the table of contents (no self-entry)
\endgroup

\pagestyle{fancy} % Enable default headers and footers again

\cleardoublepage % Start the following content on a new page

%----------------------------------------------------------------------------------------
%	HEADING COLORS (chapters/sections/subsections in text)
%----------------------------------------------------------------------------------------

% Chapter heading: ocre, same font size as default
\titleformat{\chapter}
  {\normalfont\huge\bfseries\color{ocre}} % format
  {\thechapter}                            % label
  {1em}                                    % sep
  {#1}                                     % before-code (title text)

% Unnumbered chapters (\chapter*)
\titleformat{name=\chapter,numberless}
  {\normalfont\huge\bfseries\color{ocre}}
  {}
  {0pt}
  {#1}

% Section heading
\titleformat{\section}
  {\normalfont\Large\bfseries\color{ocre}}
  {\thesection}
  {1em}
  {#1}

% Unnumbered sections (\section*)
\titleformat{name=\section,numberless}
  {\normalfont\Large\bfseries\color{ocre}}
  {}
  {0pt}
  {#1}

% Subsection heading
\titleformat{\subsection}
  {\normalfont\large\bfseries\color{ocre}}
  {\thesubsection}
  {1em}
  {#1}

% Unnumbered subsections (\subsection*)
\titleformat{name=\subsection,numberless}
  {\normalfont\large\bfseries\color{ocre}}
  {}
  {0pt}
  {#1}

% Define a macro for keywords, the keywords are displayed in italic
\newcommand{\keywords}[1]{Keywords: \textit{#1}}

% Vocabulary/glossary helper:
%   #1 = key (no spaces, e.g. hanging-pawns)
%   #2 = word as printed in the text (e.g. hanging pawns)
%   #3 = meaning (definition) - if empty, no glossary entry is created
\newcommand{\vocab}[3]{%
  \ifstrempty{#3}{%
    \gls{#1}% just print the text without creating glossary entry
  }{%
    \newglossaryentry{#1}{name={#2},description={#3}}%
    \gls{#1}% first use also prints as a glossary link
  }%
}

% Include chess tools (relative to the book folder)
\input{../cards/chess/chess-tool}

%----------------------------------------------------------------------------------------
%	End of preprocess (shared preamble/front matter)
%----------------------------------------------------------------------------------------


